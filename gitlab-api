#!/usr/bin/env bash

SELF=$(basename $0)

# Full path to the Gitlab UI view
GITLAB_URL=${GITLAB_URL:-https://code.corp.indeed.com}

# Generic options to pass to `curl` before the method & headers
CURL_OPTS=${CURL_OPTS:--s}

# Path to the API endpoint.
GITLAB_API_URL=${GITLAB_URL}/api/v4

# "username" to use to search for the key in the keychain
TOKEN_ACCOUNT=${TOKEN_ACCOUNT:-${LDAPUSER}}

function usage {
    cat <<USAGE
$SELF: Convenience wrapper for the Gitlab API.

USAGE:
    $SELF method path [rest...]

ARGUMENTS:
    method
        HTTP method to use when making the Gitlab request. GET, POST, PUT, etc.
    path
        Path relative to ${GITLAB_API_URL} of the API request.
    rest...
        All other arguments are blindly forwarded to \`curl\`.

EXAMPLES:
    gitlab-api GET /projects
    gitlab-api POST /projects/foo%2fbar/merge_requests/1/comments -d '...'
USAGE
    exit 1
}

function get_token {
    [[ -v GITLAB_TOKEN ]] && return 0

    local gitlab_domain="${GITLAB_URL#*://}"
    gitlab_domain="${gitlab_domain%%/*}"
    GITLAB_TOKEN=$(security find-internet-password \
        -s "$gitlab_domain" \
        -a "$TOKEN_ACCOUNT" \
        -w)

    [[ $? == 0 ]] && return 0

    local entry_comment="Autogenerated by $SELF script."
    cat <<TOKEN >&2
Could not find either a GITLAB_TOKEN environment variable or an appropriate
OSX keychain entry. Go to:

    ${GITLAB_URL}/profile/personal_access_tokens

And create a personal access token for this script to use. This script will
prompt you for your token and save it in the OSX keychain as an entry with
the following details:

    Name: $gitlab_domain
    Kind: Internet password
    Account: $TOKEN_ACCOUNT
    Where: $GITLAB_URL
    Comment: $entry_comment

TOKEN
    echo -n "API token for $GITLAB_URL: " >&2
    read -s GITLAB_TOKEN
    security add-internet-password \
        -a "$TOKEN_ACCOUNT" \
        -s "$gitlab_domain" \
        -r htps \
        -j "$entry_comment" \
        -w "$GITLAB_TOKEN"
}

call_api() {
    local method=$1
    # relative to GITLAB_API_URL
    local path=$2
    shift 2 || usage

    get_token || return 0

    curl "$CURL_OPTS" -X "$method" \
        -H "Private-Token: $GITLAB_TOKEN" \
        -H "Content-Type: application/json" \
        "${GITLAB_API_URL%/}/${path#/}" \
        "$@"
}

call_api "$@"

